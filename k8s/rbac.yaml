---
# Kubernetes RBAC Configuration for Nextflow
# ===========================================
#
# WHAT IS RBAC?
# Role-Based Access Control - defines WHO can do WHAT
#
# WHY DOES NEXTFLOW NEED PERMISSIONS?
# Nextflow dynamically creates and deletes pods for each task in the pipeline.
# Without proper permissions, it can't manage these worker pods.
#
# RBAC COMPONENTS:
# 1. ServiceAccount: Identity (WHO)
# 2. Role: Permissions (WHAT actions on WHAT resources)
# 3. RoleBinding: Connection (WHO can do WHAT)
#
# ============================================================================

---
# 1. SERVICE ACCOUNT
# ==================
# This is the identity that Nextflow will use
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nextflow-sa
  namespace: bioinformatics
  
  labels:
    app: nextflow
    component: orchestrator
  
  annotations:
    description: "Service account for Nextflow pipeline orchestration"

---
# 2. ROLE
# =======
# Defines WHAT actions are allowed on WHAT resources
#
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: nextflow-role
  namespace: bioinformatics
  
  labels:
    app: nextflow
    component: rbac
  
  annotations:
    description: "Permissions for Nextflow to manage worker pods and access storage"

rules:
  # ============================================================================
  # RULE 1: Pod Management
  # ============================================================================
  #
  - apiGroups: [""]  # "" = core API group
    resources: 
      - pods           # The pods themselves
      - pods/log       # Access to pod logs (for monitoring)
      - pods/status    # Check if pods are running/completed/failed
    verbs:
      - get            # Read pod details
      - list           # List all pods
      - watch          # Watch for pod state changes (real-time)
      - create         # Create new worker pods
      - delete         # Delete completed worker pods
      - patch          # Update pod metadata (labels, annotations)
  
  # ============================================================================
  # RULE 2: Pod Execution
  # ============================================================================
  #
  - apiGroups: [""]
    resources:
      - pods/exec      # Execute commands in running pods
    verbs:
      - create         # Create exec sessions
  
  
  # ============================================================================
  # RULE 3: Storage Access
  # ============================================================================
  - apiGroups: [""]
    resources:
      - persistentvolumeclaims  # PVCs for shared data
    verbs:
      - get            # Read PVC details
      - list           # List available PVCs
  
  
  # ============================================================================
  # RULE 4: ConfigMaps and Secrets (Optional)
  # ============================================================================
  #
  - apiGroups: [""]
    resources:
      - configmaps     # Configuration data
      - secrets        # Sensitive data (API keys, passwords)
    verbs:
      - get            # Read config/secrets
      - list           # List available config/secrets
  
  
  # ============================================================================
  # RULE 5: Service Access (Optional)
  # ============================================================================
  #
  - apiGroups: [""]
    resources:
      - services       # Kubernetes services
    verbs:
      - get            # Read service details
      - list           # List available services

---
# 3. ROLE BINDING
# ===============
# Connects the ServiceAccount to the Role
# Says: "nextflow-sa CAN DO everything in nextflow-role"
#
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: nextflow-rolebinding
  namespace: bioinformatics
  
  labels:
    app: nextflow
    component: rbac
  
  annotations:
    description: "Binds nextflow-sa to nextflow-role"

subjects:
  # WHO: The ServiceAccount that gets the permissions
  - kind: ServiceAccount
    name: nextflow-sa
    namespace: bioinformatics

roleRef:
  # WHAT: The Role that defines the permissions
  kind: Role
  name: nextflow-role
  apiGroup: rbac.authorization.k8s.io

---
# ============================================================================
# SECURITY BEST PRACTICES
# ============================================================================
#
# 1. PRINCIPLE OF LEAST PRIVILEGE:
#    Only grant permissions that are actually needed
#    Don't give cluster-admin or wildcard permissions
#
# 2. NAMESPACE ISOLATION:
#    Use Role (not ClusterRole) to limit scope to one namespace
#    This prevents Nextflow from affecting other namespaces
#
# 3. AUDIT LOGGING:
#    Enable Kubernetes audit logs to track what Nextflow does
#    Monitor for suspicious activity (unexpected pod creation)
#
# 4. NETWORK POLICIES:
#    Restrict network access to/from Nextflow pods
#    Only allow necessary communication
#
# 5. POD SECURITY POLICIES/STANDARDS:
#    Enforce security constraints on created pods:
#      - Run as non-root user
#      - Read-only root filesystem
#      - No privileged containers
#      - Drop all capabilities
#
# 6. SECRETS MANAGEMENT:
#    Use external secrets management (AWS Secrets Manager, Vault)
#    Don't store secrets in ConfigMaps
#    Rotate credentials regularly
#
# 7. RESOURCE QUOTAS:
#    Limit total resources Nextflow can consume
#    Prevent runaway jobs from taking down the cluster
#
# ============================================================================

---
# TROUBLESHOOTING RBAC ISSUES
# ============================
#
# SYMPTOM: "Error: pods is forbidden"
# CAUSE: ServiceAccount doesn't have permission to create pods
# FIX: Check that RoleBinding is applied and references correct Role
#
# SYMPTOM: "Error: persistentvolumeclaims is forbidden"
# CAUSE: ServiceAccount can't access PVCs
# FIX: Add PVC permissions to Role (see RULE 3 above)
#
# SYMPTOM: Pods created but can't access storage
# CAUSE: PVC doesn't exist or wrong access mode
# FIX: Check storage.yaml is applied and PVC is ReadWriteMany
#
# SYMPTOM: "Error: serviceaccounts 'nextflow-sa' not found"
# CAUSE: ServiceAccount not created or wrong namespace
# FIX: Apply this file: kubectl apply -f rbac.yaml
#
# DEBUGGING COMMANDS:
#   # Check if ServiceAccount exists
#   kubectl get serviceaccount nextflow-sa -n bioinformatics
#   
#   # Check if Role exists
#   kubectl get role nextflow-role -n bioinformatics
#   
#   # Check if RoleBinding exists
#   kubectl get rolebinding nextflow-rolebinding -n bioinformatics
#   
#   # Describe Role (see permissions)
#   kubectl describe role nextflow-role -n bioinformatics
#   
#   # Test permissions (from a pod using the ServiceAccount)
#   kubectl auth can-i create pods --as=system:serviceaccount:bioinformatics:nextflow-sa -n bioinformatics
#   
#   # View all permissions for ServiceAccount
#   kubectl auth can-i --list --as=system:serviceaccount:bioinformatics:nextflow-sa -n bioinformatics

